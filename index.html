<!doctype html>
<html lang="id">

<head>
    <meta charset="utf-8" />
    <title>WebGIS BPS-PI: Complete System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <style>
        /* --- CSS VARIABLES --- */
        
         :root {
            --primary-theme: #3687e3;
            --primary-dark: #173bef;
            --header-height: 60px;
            --panel-width: 360px;
            --bg-light: #f5f7fa;
        }
        
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
            background: var(--bg-light);
        }
        /* HEADER */
        
        .app-header {
            height: var(--header-height);
            background-color: var(--primary-theme);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            position: relative;
        }
        
        .logo-box {
            background: white;
            color: var(--primary-theme);
            padding: 5px 12px;
            border-radius: 6px;
            font-weight: 800;
            font-size: 16px;
            margin-right: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .nav-btn {
            background: transparent;
            border: none;
            color: white;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 18px;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .nav-btn.active {
            background: rgba(0, 0, 0, 0.25);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        /* CONTAINER */
        
        .main-container {
            position: relative;
            height: calc(100vh - var(--header-height));
            width: 100%;
            display: flex;
        }
        
        #map {
            flex: 1;
            height: 100%;
            z-index: 1;
            background: #eef2f3;
        }
        
        .loading-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            color: #333;
            padding: 25px;
            border-radius: 8px;
            z-index: 3000;
            display: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            font-weight: 500;
            border: 1px solid #ddd;
        }
        /* SIDEBAR */
        
        .right-sidebar {
            width: var(--panel-width);
            background: white;
            border-left: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.05);
            z-index: 1001;
            transition: transform 0.3s ease;
        }
        
        .right-sidebar.collapsed {
            display: none;
        }
        
        .panel-header {
            background: var(--primary-theme);
            color: white;
            padding: 18px 20px;
            font-weight: 500;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        
        .panel-content {
            flex: 1;
            overflow-y: auto;
            background: #f9f9f9;
            padding-bottom: 20px;
        }
        
        .layer-group-header {
            background: #e0f2f1;
            padding: 12px 20px;
            font-size: 12px;
            font-weight: 700;
            color: #00695C;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #b2dfdb;
            border-top: 1px solid #b2dfdb;
        }
        
        .layer-item {
            background: white;
            padding: 14px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 14px;
            transition: background 0.1s;
        }
        
        .layer-item:hover {
            background-color: #fafafa;
        }
        
        .layer-left {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            width: 100%;
        }
        
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-theme);
            cursor: pointer;
        }
        /* ANALYSIS TOOLS */
        
        .analysis-card {
            background: white;
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .analysis-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: 0.2s;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .analysis-btn:active {
            transform: translateY(1px);
            box-shadow: none;
        }
        
        .analysis-btn.active {
            box-shadow: inset 0 0 0 3px rgba(0, 0, 0, 0.2);
        }
        
        .btn-green {
            background: #43A047;
        }
        
        .btn-green:hover {
            background: #2E7D32;
        }
        
        .btn-orange {
            background: #FB8C00;
        }
        
        .btn-orange:hover {
            background: #EF6C00;
        }
        
        .btn-blue {
            background: #1E88E5;
        }
        
        .btn-blue:hover {
            background: #1565C0;
        }
        
        .analysis-desc {
            font-size: 13px;
            color: #666;
            margin-top: 10px;
            line-height: 1.5;
            padding: 0 5px;
        }
        
        .result-container {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #e8f5e9;
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.5;
            color: #2e7d32;
            animation: fadeIn 0.3s;
        }
        
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
            font-size: 12px;
            background: white;
        }
        
        .stats-table th {
            background: #00897B;
            color: white;
            padding: 8px;
            text-align: left;
        }
        
        .stats-table td {
            border-bottom: 1px solid #eee;
            padding: 8px;
            color: #333;
        }
        
        .stats-table tr:last-child td {
            border-bottom: none;
            font-weight: bold;
            background: #f0f0f0;
        }
        /* FLOATING TOOLS */
        
        .floating-left {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .search-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            width: 340px;
            height: 46px;
            overflow: hidden;
            border: 1px solid #ddd;
        }
        
        .search-container input {
            border: none;
            flex: 1;
            padding: 0 15px;
            outline: none;
            font-family: inherit;
            font-size: 14px;
        }
        
        .search-container button {
            background: white;
            border: none;
            padding: 0 18px;
            cursor: pointer;
            color: #666;
            border-left: 1px solid #eee;
            transition: 0.2s;
        }
        
        .search-container button:hover {
            color: var(--primary-theme);
            background: #f5f5f5;
        }
        
        .tools-grid {
            display: flex;
            gap: 10px;
            position: relative;
        }
        
        .tool-btn {
            width: 46px;
            height: 46px;
            background: white;
            color: #555;
            border: 1px solid #ccc;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: 0.2s;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }
        
        .tool-btn:hover {
            background: #f0f0f0;
            color: var(--primary-theme);
            transform: translateY(-1px);
        }
        
        .tool-btn.active {
            background: var(--primary-theme);
            color: white;
            border-color: var(--primary-theme);
        }
        
        .basemap-menu {
            position: absolute;
            top: 52px;
            left: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            width: 180px;
            display: none;
            overflow: hidden;
            border: 1px solid #ddd;
        }
        
        .basemap-menu.show {
            display: block;
            animation: fadeIn 0.2s;
        }
        
        .basemap-option {
            padding: 12px 15px;
            cursor: pointer;
            font-size: 13px;
            color: #444;
            transition: 0.1s;
            border-bottom: 1px solid #f1f1f1;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .basemap-option:hover {
            background: #e0f2f1;
            color: var(--primary-theme);
        }
        /* MODALS (INFO & PRINT) */
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 4000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(3px);
        }
        
        .modal-box {
            background: white;
            width: 500px;
            max-width: 90%;
            border-radius: 10px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            animation: slideDown 0.3s;
        }
        
        .modal-header {
            background: var(--primary-theme);
            color: white;
            padding: 18px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            font-size: 18px;
        }
        
        .modal-body {
            padding: 25px;
            font-size: 14px;
            line-height: 1.6;
            color: #444;
        }
        
        .modal-footer {
            padding: 15px 25px;
            border-top: 1px solid #eee;
            text-align: right;
            background: #f9f9f9;
        }
        
        .btn-close {
            background: #546e7a;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        /* FORM PRINT */
        
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: #333;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .btn-print-action {
            background: var(--primary-theme);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        /* ZOOM & LEGEND */
        
        .bottom-tools {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 30px;
            margin-left: 20px;
        }
        
        .zoom-btn {
            width: 40px;
            height: 40px;
            background: white;
            color: #555;
            border: 1px solid #ccc;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            transition: 0.2s;
            font-size: 16px;
        }
        
        .zoom-btn:hover {
            background: #f5f5f5;
            color: var(--primary-theme);
        }
        
        .leg-icon {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid white;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.3);
        }
        
        .leaflet-control-coordinates {
            background: rgba(255, 255, 255, 0.95);
            padding: 6px 12px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            font-size: 11px;
            font-family: monospace;
            color: #444;
            border: 1px solid #ddd;
            margin-right: 10px;
            margin-bottom: 5px;
        }
        /* POPUP & LABELS */
        
        .leaflet-popup-content {
            font-family: 'Roboto', sans-serif !important;
            font-size: 13px;
            line-height: 1.5;
            margin: 15px;
            min-width: 240px;
        }
        
        .leaflet-popup-content b {
            color: #333;
        }
        
        .leaflet-popup-content a {
            color: var(--primary-theme);
            text-decoration: none;
            font-weight: 500;
        }
        
        .distance-label {
            background: white;
            border: 1px solid #00897B;
            color: #00897B;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            white-space: nowrap;
        }
        
        .faskes-label {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #666;
            color: #333;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 500;
            white-space: nowrap;
            margin-top: -10px;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        /* --- PRINT CSS --- */
        
        @media print {
            @page {
                margin: 0;
            }
            body {
                background: white;
            }
            .app-header,
            .floating-left,
            .right-sidebar,
            .bottom-tools,
            .leaflet-control-zoom,
            .modal-overlay {
                display: none !important;
            }
            .main-container {
                height: 100vh;
                width: 100vw;
                position: absolute;
                top: 0;
                left: 0;
                z-index: 1;
            }
            #map {
                width: 100%;
                height: 100%;
            }
            #printHeaderOverlay {
                display: block !important;
                position: absolute;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 9999;
                background: rgba(255, 255, 255, 0.9);
                padding: 15px 30px;
                border-radius: 8px;
                border: 2px solid var(--primary-theme);
                text-align: center;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            }
            #printHeaderOverlay h2 {
                margin: 0;
                color: var(--primary-theme);
                font-size: 24px;
            }
            #printHeaderOverlay p {
                margin: 5px 0 0;
                color: #555;
                font-size: 14px;
            }
            .leaflet-control-scale {
                display: block !important;
            }
        }
    </style>
</head>

<body>

    <header class="app-header">
        <div style="display:flex;align-items:center">
            <img src="pendidikan.png" alt="Logo" style="height:40px; margin-right:15px;">

            <div style="display:flex; flex-direction:column;">
                <span style="font-weight:700; font-size:18px; line-height:1.2">WebGIS BPS-PI</span>
                <span style="font-size:12px; opacity:0.9">Fasilitas Pendidikan</span>
            </div>
        </div>

        <div style="display:flex; align-items:center">
            <button class="nav-btn active" id="navLayer" title="Layer" onclick="switchPanel('layer')"><i class="fa-solid fa-layer-group"></i></button>
            <button class="nav-btn" id="navAnalysis" title="Analisis" onclick="switchPanel('analysis')"><i class="fa-solid fa-chart-pie"></i></button>
            <div style="height:24px;width:1px;background:rgba(255,255,255,0.3);margin:0 15px;"></div>
            <button class="nav-btn" title="Tentang Aplikasi" onclick="toggleInfoModal()"><i class="fa-solid fa-circle-info"></i></button>
        </div>
    </header>

    <div class="main-container">
        <div id="map"></div>
        <div id="loading" class="loading-modal"><i class="fa-solid fa-circle-notch fa-spin" style="margin-right:10px; color:var(--primary-theme)"></i> Memuat Data & Peta...</div>

        <div id="printHeaderOverlay" style="display:none;">
            <h2 id="printTitleText">Peta Fasilitas Pendidikan</h2>
            <p>Sumber: WebGIS BPS-PI | Dicetak pada: <span id="printDate"></span></p>
        </div>

        <div id="infoModal" class="modal-overlay" style="display:flex;">
            <div class="modal-box">
                <div class="modal-header"><span>Tentang Aplikasi</span><i class="fa-solid fa-xmark" style="cursor:pointer" onclick="toggleInfoModal()"></i></div>
                <div class="modal-body">
                    <h3 style="margin-top:0; color:var(--primary-theme); font-size:16px;">Selamat Datang di WebGIS Pendidikan Bandung</h3>
                    <p>Aplikasi ini menampilkan persebaran fasilitas pendidikan di wilayah Kota dan Kabupaten Bandung.</p>
                    <p><b>Fitur Utama:</b></p>
                    <ul style="padding-left:20px; color:#555">
                        <li>Visualisasi lokasi Sekolah.</li>
                        <li>Analisis jangkauan layanan (Buffer Zone).</li>
                        <li>Pencarian fasilitas pendidikan terdekat (dengan visualisasi jarak).</li>
                        <li>Statistik jumlah fasilitas per Kecamatan.</li>
                    </ul>
                </div>
                <div class="modal-footer"><button class="btn-close" onclick="toggleInfoModal()">Tutup</button></div>
            </div>
        </div>

        <div id="printModal" class="modal-overlay">
            <div class="modal-box" style="width: 420px;">
                <div class="modal-header"><span>Print Plus</span><i class="fa-solid fa-xmark" style="cursor:pointer" onclick="togglePrintModal()"></i></div>
                <div class="modal-body">
                    <div class="form-group"><label>Judul Peta:</label><input type="text" id="inputPrintTitle" class="form-control" value="Peta Fasilitas Pendidikan Bandung" placeholder="Masukkan judul peta..."></div>
                    <div class="form-group"><label>Layout Kertas:</label><select id="inputPrintLayout" class="form-control"><option value="landscape">A4 Landscape</option><option value="portrait">A4 Portrait</option></select></div>
                    <div class="form-group"><label>Format:</label><select class="form-control" disabled style="background:#eee;"><option>PDF (via Browser Print)</option></select></div>
                    <div style="background:#e0f2f1; padding:10px; border-radius:6px; font-size:12px; color:#00695C; margin-top:10px;"><i class="fa-solid fa-circle-info"></i> <b>Tips:</b> Saat dialog print browser muncul, pastikan memilih <b>"Save as PDF"</b> dan atur Layout sesuai pilihan.</div>
                </div>
                <div class="modal-footer">
                    <button class="btn-close" onclick="togglePrintModal()" style="background:#ddd; color:#333; margin-right:10px;">Batal</button>
                    <button class="btn-print-action" onclick="executePrint()"><i class="fa-solid fa-print"></i> Cetak Peta</button>
                </div>
            </div>
        </div>

        <div class="floating-left">
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Cari SD/SMP/SMA/Sekolah Terpadu..." onkeypress="handleSearch(event)">
                <button onclick="doSearch()"><i class="fa-solid fa-magnifying-glass"></i></button>
            </div>
            <div class="tools-grid">
                <div style="position:relative">
                    <button class="tool-btn" id="btnBasemap" title="Peta Dasar" onclick="toggleBasemapMenu()"><i class="fa-solid fa-map"></i></button>
                    <div id="basemapDropdown" class="basemap-menu">
                        <div class="basemap-option" onclick="changeBasemap('osm')"><i class="fa-solid fa-road"></i> OpenStreetMap</div>
                        <div class="basemap-option" onclick="changeBasemap('sat')"><i class="fa-solid fa-satellite"></i> Citra Satelit</div>
                        <div class="basemap-option" onclick="changeBasemap('topo')"><i class="fa-solid fa-mountain"></i> Topografi</div>
                    </div>
                </div>
                <button class="tool-btn" id="btnMeasure" title="Ukur Jarak" onclick="activateTool('measure')"><i class="fa-solid fa-ruler-combined"></i></button>
                <button class="tool-btn" title="Print Plus" onclick="togglePrintModal()"><i class="fa-solid fa-print"></i></button>
            </div>
        </div>

        <div class="right-sidebar" id="sidebarPanel">
            <div class="panel-header">
                <span id="panelTitle">Daftar Layer</span>
                <i class="fa-solid fa-xmark" style="cursor:pointer" onclick="toggleSidebar()"></i>
            </div>
            <div class="panel-content">

                <div id="viewLayers">
                    <div class="layer-group-header">Administrasi</div>
                    <div class="layer-item"><label class="layer-left"><input type="checkbox" id="chkLvl1" checked onchange="toggleLayer('lvl1')"><span>Batas Kabupaten/Kota</span></label></div>
                    <div class="layer-item"><label class="layer-left"><input type="checkbox" id="chkLvl2" checked onchange="toggleLayer('lvl2')"><span>Batas Kecamatan</span></label></div>
                    <div class="layer-item"><label class="layer-left"><input type="checkbox" id="chkLvl3" checked onchange="toggleLayer('lvl3')"><span>Batas Kelurahan/Desa</span></label></div>

                    <div class="layer-group-header">Fasilitas Pendidikan</div>
                    <div class="layer-item"><label class="layer-left"><input type="checkbox" id="chkSD" checked onchange="toggleLayer('SD')"><span><span class="leg-icon" style="background:#D32F2F"></span> SD Sederajat</span></label></div>
                    <div class="layer-item"><label class="layer-left"><input type="checkbox" id="chkSMP" checked onchange="toggleLayer('SMP')"><span><span class="leg-icon" style="background:#1976D2"></span> SMP Sederajat</span></label></div>
                    <div class="layer-item"><label class="layer-left"><input type="checkbox" id="chkSMA" checked onchange="toggleLayer('SMA')"><span><span class="leg-icon" style="background:#a8b6a8"></span> SMA Sederajat</span></label></div>
                    <div class="layer-item"><label class="layer-left"><input type="checkbox" id="chkTerpadu" checked onchange="toggleLayer('Terpadu')"><span><span class="leg-icon" style="background:#fff707"></span> Sekolah Terpadu</span></label></div>
                    <div class="layer-item"><label class="layer-left"><input type="checkbox" id="chkBuffer" onchange="toggleLayer('buffer')"><span>Tampilkan Buffer Jangkauan</span></label></div>
                </div>

                <div id="viewAnalysis" style="display:none">

                    <div class="analysis-card">
                        <button class="analysis-btn btn-blue" onclick="runDistrictAnalysis()">
                            <i class="fa-solid fa-table-list"></i> Statistik per Kecamatan
                        </button>
                        <div class="analysis-desc">Menampilkan tabel jumlah fasilitas pendidikan di setiap kecamatan.</div>
                        <div id="res-district" class="result-container" style="padding:0; overflow:hidden;"></div>
                    </div>

                    <div class="analysis-card">
                        <button class="analysis-btn btn-green" onclick="runCoverageAnalysis()">
                            <i class="fa-solid fa-chart-area"></i> Hitung Cakupan Layanan
                        </button>
                        <div class="analysis-desc">Hitung % wilayah yang terjangkau buffer sekolah aktif.</div>
                        <div id="res-coverage" class="result-container"></div>
                    </div>

                    <div class="analysis-card">
                        <button id="btnAnalysisTool" class="analysis-btn btn-orange" onclick="activateTool('analysis')">
                            <i class="fa-solid fa-location-crosshairs"></i> Cari 5 Sekolah Terdekat
                        </button>
                        <div class="analysis-desc">Klik tombol, lalu <b>klik titik di peta</b> untuk mencari 5 sekolah terdekat dengan visualisasi jarak.</div>
                        <div id="res-nearest" class="result-container"></div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

    <script>
        // 1. INIT MAP
        const map = L.map('map', {
            zoomControl: false,
            doubleClickZoom: true
        }).setView([-6.914744, 107.609810], 11);

        // EXTRA CONTROLS
        L.control.scale({
            position: 'bottomright',
            metric: true,
            imperial: false
        }).addTo(map);
        const CoordControl = L.Control.extend({
            options: {
                position: 'bottomright'
            },
            onAdd: function(map) {
                this._div = L.DomUtil.create('div', 'leaflet-control-coordinates');
                this._div.innerHTML = "Lat: - | Lng: -";
                return this._div;
            },
            update: function(lat, lng) {
                this._div.innerHTML = `Lat: ${lat.toFixed(5)} | Lng: ${lng.toFixed(5)}`;
            }
        });
        const coordBox = new CoordControl();
        map.addControl(coordBox);
        map.on('mousemove', function(e) {
            coordBox.update(e.latlng.lat, e.latlng.lng);
        });

        // LAYERS
        // Admin Pane (Non-Interactive)
        map.createPane('adminPane');
        map.getPane('adminPane').style.zIndex = 200;
        map.getPane('adminPane').style.pointerEvents = 'none';

        const adminLvl1 = L.layerGroup();
        const adminLvl2 = L.layerGroup();
        const adminLvl3 = L.layerGroup();
        const clusterSD = L.markerClusterGroup();
        const clusterSMP = L.markerClusterGroup();
        const clusterSMA = L.markerClusterGroup();
        const clusterTerpadu = L.markerClusterGroup();
        const bufferSD = L.layerGroup();
        const bufferSMP = L.layerGroup();
        const bufferSMA = L.layerGroup();
        const bufferTerpadu = L.layerGroup();
        const toolGroup = L.layerGroup().addTo(map);

        // BASEMAPS
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }).addTo(map);
        const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19
        });
        const topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            maxZoom: 17
        });

        // DATA STORE
        let KAB_MAP = {};
        let KEC_MAP = {};
        let FASKES_SOURCE = [];
        let GEO_ADMIN_LVL1 = [];
        let GEO_ADMIN_LVL2 = [];
        let activeTool = null;
        let measurePoints = [];

        // USER ICON (FontAwesome)
        const userIcon = L.divIcon({
            className: 'custom-user-marker',
            html: `<div style="background-color:white; width:36px; height:36px; border-radius:50%; border:3px solid #00897B; display:flex; justify-content:center; align-items:center; box-shadow:0 3px 6px rgba(0,0,0,0.3);"><i class="fa-solid fa-user" style="color:#00897B; font-size:18px;"></i></div><div style="width:0; height:0; border-left:6px solid transparent; border-right:6px solid transparent; border-top:8px solid #00897B; margin:-2px auto 0;"></div>`,
            iconSize: [36, 44],
            iconAnchor: [18, 44],
            popupAnchor: [0, -40]
        });

        async function safeFetch(url) {
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error('404');
                return await res.json();
            } catch (e) {
                return null;
            }
        }

        function buildPopup(props, tipe) {
            return `
                <b style="font-size:15px;">${props.name || 'Tanpa Nama'}</b><br>
                <span style="background:#2196F3; color:white; padding:2px 6px; border-radius:4px; font-size:11px;">
                    ${tipe}
                </span>
                <hr>
                ${props.alamat ? 'üìç ' + props.alamat + '<br>' : ''}
                ${props.status ? 'üè´ ' + props.status : ''}
            `;
        }

        // ===========================================
        // LOAD DATA
        // ===========================================
        async function loadSmartData() {
            document.getElementById('loading').style.display = 'block';
            try {
                            // ================= ADMINISTRASI =================
                const adminKab = await safeFetch('Batas_Kota.geojson');
                const adminKec = await safeFetch('Batas_Kecamatan.geojson');
                const adminKel = await safeFetch('Batas_Desa.geojson');

                // LEVEL 1
                if (adminKab) {
                    GEO_ADMIN_LVL1.push(adminKab);
                    L.geoJSON(adminKab, {
                        pane: 'adminPane',
                        interactive: false,
                        style: {
                            color: '#00897B',
                            weight: 2,
                            fillOpacity: 0
                        }
                    }).addTo(adminLvl1);
                }

                // LEVEL 2
                if (adminKec) {
                    GEO_ADMIN_LVL2.push(adminKec);
                    L.geoJSON(adminKec, {
                        pane: 'adminPane',
                        interactive: false,
                        style: {
                            color: '#FF9800',
                            weight: 1,
                            dashArray: '5,5',
                            fillOpacity: 0.05
                        }
                    }).addTo(adminLvl2);
                }

                // LEVEL 3
                if (adminKel) {
                    L.geoJSON(adminKel, {
                        pane: 'adminPane',
                        interactive: false,
                        style: {
                            color: '#7B1FA2',
                            weight: 0.5,
                            fillOpacity: 0.05,
                            fillColor: '#E1BEE7'
                        }
                    }).addTo(adminLvl3);
                }

                // Faskes
                const dataSekolah = await safeFetch('Sekolah_Bandung2.geojson');
                if (dataSekolah) {
                    FASKES_SOURCE = dataSekolah.features;

                    L.geoJSON(dataSekolah, {
                        pointToLayer: (f, latlng) => {
                            const p = f.properties;
                            const jenjang = (p.Jenjang || '').toLowerCase();

                            const addSchool = (color, label, markerGrp, bufferGrp, radius) => {
                                const m = L.circleMarker(latlng, {
                                    radius: 7,
                                    fillColor: color,
                                    color: 'white',
                                    weight: 1,
                                    fillOpacity: 1
                                }).bindPopup(buildPopup(p, label));
                                markerGrp.addLayer(m);

                                L.circle(latlng, {
                                    radius: radius,
                                    color: color,
                                    fillOpacity: 0.35,
                                    weight: 0,
                                    interactive: false
                                }).addTo(bufferGrp);
                            };

                            if (jenjang.includes('sd')) {
                                    addSchool('#D32F2F', 'SD Sederajat', clusterSD, bufferSD, 1000);
                                }
                                else if (jenjang.includes('smp')) {
                                    addSchool('#1976D2', 'SMP Sederajat', clusterSMP, bufferSMP, 3000);
                                }
                                else if (jenjang.includes('sma')) {
                                    addSchool('#388E3C', 'SMA Sederajat', clusterSMA, bufferSMA, 10000);
                                }
                                else if (jenjang.includes('terpadu')) {
                                    addSchool('#D32F2F', 'Sekolah Terpadu', clusterTerpadu, bufferTerpadu, 1000);
                                    addSchool('#1976D2', 'Sekolah Terpadu', clusterTerpadu, bufferTerpadu, 3000);
                                    addSchool('#388E3C', 'Sekolah Terpadu', clusterTerpadu, bufferTerpadu, 10000);
                                }

                        }
                    });
                }

                document.getElementById('loading').style.display = 'none';
            } catch (e) {
                document.getElementById('loading').innerText = "Gagal memuat data";
            }
        }

        
        loadSmartData();

        

        // INIT LAYERS
        if (document.getElementById('chkLvl1').checked) map.addLayer(adminLvl1);
        if (document.getElementById('chkLvl2').checked) map.addLayer(adminLvl2);
        if (document.getElementById('chkLvl3').checked) map.addLayer(adminLvl3);
        if (document.getElementById('chkSD').checked) map.addLayer(clusterSD);
        if (document.getElementById('chkSMP').checked) map.addLayer(clusterSMP);
        if (document.getElementById('chkSMA').checked) map.addLayer(clusterSMA);
        if (document.getElementById('chkTerpadu').checked) map.addLayer(clusterTerpadu);
        updateBufferVisibility();

        // ===========================================
        // FITUR ANALISIS (VISUALISASI KEREN)
        // ===========================================

        function clearResults() {
            ['res-district', 'res-coverage', 'res-nearest'].forEach(id => {
                document.getElementById(id).style.display = 'none';
                document.getElementById(id).innerHTML = '';
            });
        }

        // 1. STATISTIK
        function runDistrictAnalysis() {
            clearResults();
            const resDiv = document.getElementById('res-district');
            resDiv.style.display = 'block';
            if (!GEO_ADMIN_LVL2.length || !FASKES_SOURCE.length) {
                resDiv.innerText = "Data belum siap.";
                return;
            }

            let stats = [];
            GEO_ADMIN_LVL2.forEach(geo => {
                geo.features.forEach(kec => {
                    const ptsWithin = turf.pointsWithinPolygon(turf.featureCollection(FASKES_SOURCE), kec);
                    if (ptsWithin.features.length > 0) {
                        let sd = 0,
                            smp = 0,
                            sma = 0,
                            terpadu = 0;
                        ptsWithin.features.forEach(pt => {
                            const a = (pt.properties.Jenjang || '').toLowerCase();
                            if (a.includes('sd')) sd++;
                            else if (a.includes('smp')) smp++;
                            else if (a.includes('sma')) sma++;
                            else if (a.includes('terpadu')) terpadu++;
                        });
                        stats.push({
                            nama: kec.properties.NAMOBJ || 'Tanpa Nama',
                            sd, smp, sma, terpadu,
                            total: sd + smp + sma + terpadu
                        });
                    }
                });
            });
            stats.sort((a, b) => b.total - a.total);
            let html = `<div style="max-height:200px; overflow-y:auto;"><table class="stats-table"><tr><th>Kecamatan</th><th>SD</th><th>SMP</th><th>SMA</th><th>Terpadu</th><th>Total</th></tr>`;
            stats.forEach(s => {
                html += `<tr><td>${s.nama}</td><td>${s.sd}</td><td>${s.smp}</td><td>${s.sma}</td><td>${s.terpadu}</td><td><b>${s.total}</b></td></tr>`;
            });
            html += `</table></div>`;
            resDiv.innerHTML = html;
        }

        // 2. CAKUPAN
        function runCoverageAnalysis() {
            clearResults();
            const resDiv = document.getElementById('res-coverage');
            resDiv.style.display = 'block';
            if (!GEO_ADMIN_LVL1.length) {
                resDiv.innerText = 'Data admin belum siap.';
                return;
            }
            try {
                let activeBuffers = [];
                const addBuf = (grp) => {
                    if (map.hasLayer(grp)) {
                        grp.eachLayer(l => {
                            const center = [l.getLatLng().lng, l.getLatLng().lat];
                            const radKm = l.getRadius() / 1000;
                            activeBuffers.push(turf.circle(center, radKm, {
                                steps: 32,
                                units: 'kilometers'
                            }));
                        });
                    }
                };
                if (document.getElementById('chkBuffer').checked) {
                    if (document.getElementById('chkSD').checked) addBuf(bufferSD);
                    if (document.getElementById('chkSMP').checked) addBuf(bufferSMP);
                    if (document.getElementById('chkSMA').checked) addBuf(bufferSMA);
                    if (document.getElementById('chkTerpadu').checked) addBuf(bufferTerpadu);
                }

                if (!activeBuffers.length) {
                    resDiv.innerHTML = "<span style='color:red'>Tidak ada buffer aktif.</span>";
                    return;
                }

                let unionBuf = activeBuffers[0];
                for (let i = 1; i < activeBuffers.length; i++) unionBuf = turf.union(unionBuf, activeBuffers[i]);
                let adminGeo = null;
                GEO_ADMIN_LVL1.forEach(g => {
                    g.features.forEach(f => {
                        adminGeo = adminGeo ? turf.union(adminGeo, f) : f;
                    });
                });
                const areaAdmin = turf.area(adminGeo);
                const intersection = turf.intersect(unionBuf, adminGeo);

                if (!intersection) {
                    resDiv.innerHTML = "<span style='color:orange'>Tidak ada irisan.</span>";
                    return;
                }
                const pct = (turf.area(intersection) / areaAdmin) * 100;
                resDiv.innerHTML = `<b>${pct.toFixed(2)}%</b> wilayah administrasi terjangkau.`;
            } catch (e) {
                console.error(e);
                resDiv.innerText = 'Gagal menghitung.';
            }
        }

        // 3. NEAREST NEIGHBOR (VISUALISASI KEREN)
        function activateTool(toolName) {
            measurePoints = [];
            toolGroup.clearLayers();
            document.getElementById('btnMeasure').classList.remove('active');
            const btnAn = document.getElementById('btnAnalysisTool');

            if (toolName === 'analysis') {
                if (activeTool === 'analysis') {
                    activeTool = null;
                    map.getContainer().style.cursor = '';
                    map.doubleClickZoom.enable();
                    btnAn.classList.remove('active');
                    clearResults();
                } else {
                    activeTool = 'analysis';
                    map.getContainer().style.cursor = 'crosshair';
                    map.doubleClickZoom.disable();
                    btnAn.classList.add('active');
                    clearResults();
                    const resDiv = document.getElementById('res-nearest');
                    resDiv.style.display = 'block';
                    resDiv.innerText = "Klik titik di peta...";
                }
            } else if (toolName === 'measure') {
                activeTool = 'measure';
                map.getContainer().style.cursor = 'crosshair';
                map.doubleClickZoom.disable();
                document.getElementById('btnMeasure').classList.add('active');
                btnAn.classList.remove('active');
            }
        }

        map.on('click', function(e) {
            if (!activeTool) return;

            // MEASURE
            if (activeTool === 'measure') {
                measurePoints.push(e.latlng);
                L.circleMarker(e.latlng, {
                    color: '#444',
                    radius: 4
                }).addTo(toolGroup);
                if (measurePoints.length === 2) {
                    const p1 = measurePoints[0];
                    const p2 = measurePoints[1];
                    L.polyline([p1, p2], {
                        color: '#444',
                        dashArray: '5, 10'
                    }).addTo(toolGroup);
                    const dist = map.distance(p1, p2);
                    const km = (dist / 1000).toFixed(2);
                    L.popup().setLatLng(p2).setContent(`<b>Jarak: ${km} km</b>`).openOn(map);
                    measurePoints = [];
                }
            }

            // ANALYSIS NEAREST (IMPROVED)
            if (activeTool === 'analysis') {
                if (!FASKES_SOURCE.length) return alert('Data sekolah belum siap.');
                toolGroup.clearLayers();

                // Marker User (Orang)
                L.marker(e.latlng, {
                    icon: userIcon
                }).addTo(toolGroup).bindPopup("Lokasi Anda").openPopup();

                const centerPt = turf.point([e.latlng.lng, e.latlng.lat]);
                let measured = FASKES_SOURCE.map(f => {
                    const fPt = turf.point(f.geometry.coordinates);
                    const d = turf.distance(centerPt, fPt, {
                        units: 'kilometers'
                    });
                    return {
                        feature: f,
                        dist: d
                    };
                });
                measured.sort((a, b) => a.dist - b.dist);
                const top5 = measured.slice(0, 5);

                let html = "<b>5 Sekolah Terdekat:</b><ul style='padding-left:15px; margin:5px 0'>";
                top5.forEach(item => {
                    const c = item.feature.geometry.coordinates; // [lng, lat]
                    const nm = item.feature.properties.name || 'Tanpa Nama';
                    const latlngFaskes = [c[1], c[0]];

                    // Garis Penghubung Putus-putus
                    L.polyline([e.latlng, latlngFaskes], {
                            color: '#00838F',
                            weight: 2,
                            dashArray: '5, 10',
                            opacity: 0.8
                        }).addTo(toolGroup)
                        .bindTooltip(`<b>${item.dist.toFixed(2)} km</b>`, {
                            permanent: true,
                            direction: 'center',
                            className: 'distance-label'
                        });

                    // Tooltip Nama Faskes di Peta
                    L.circleMarker(latlngFaskes, {
                            radius: 1,
                            opacity: 0
                        }).addTo(toolGroup)
                        .bindTooltip(nm, {
                            permanent: true,
                            direction: 'bottom',
                            className: 'faskes-label',
                            offset: [0, 10]
                        });

                    html += `<li>${nm} (${item.dist.toFixed(2)} km)</li>`;
                });
                html += "</ul>";

                const resDiv = document.getElementById('res-nearest');
                resDiv.style.display = 'block';
                resDiv.innerHTML = html;
            }
        });

        // UI HELPERS
        function toggleInfoModal() {
            const m = document.getElementById('infoModal');
            m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
        }

        function togglePrintModal() {
            const m = document.getElementById('printModal');
            m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
        }

        function switchPanel(mode) {
            const sidebar = document.getElementById('sidebarPanel');
            const layerDiv = document.getElementById('viewLayers');
            const analysisDiv = document.getElementById('viewAnalysis');
            const title = document.getElementById('panelTitle');
            const btnL = document.getElementById('navLayer');
            const btnA = document.getElementById('navAnalysis');
            sidebar.style.display = 'flex';
            if (mode === 'layer') {
                layerDiv.style.display = 'block';
                analysisDiv.style.display = 'none';
                title.innerText = 'Daftar Layer';
                btnL.classList.add('active');
                btnA.classList.remove('active');
            } else {
                layerDiv.style.display = 'none';
                analysisDiv.style.display = 'block';
                title.innerText = 'Analisis Spasial';
                btnL.classList.remove('active');
                btnA.classList.add('active');
            }
        }

        function toggleSidebar() {
            const s = document.getElementById('sidebarPanel');
            s.style.display = (s.style.display === 'none') ? 'flex' : 'none';
        }

        function toggleLayer(t) {
            let l, i;
            if (t === 'lvl1') {
                l = adminLvl1;
                i = 'chkLvl1'
            } else if (t === 'lvl2') {
                l = adminLvl2;
                i = 'chkLvl2'
            } else if (t === 'lvl3') {
                l = adminLvl3;
                i = 'chkLvl3'
            } else if (t === 'SD') {
                l = clusterSD;
                i = 'chkSD'
            } else if (t === 'SMP') {
                l = clusterSMP;
                i = 'chkSMP'
            } else if (t === 'SMA') {
                l = clusterSMA;
                i = 'chkSMA'
            } else if (t === 'Terpadu') {
                l = clusterTerpadu;
                i = 'chkTerpadu'
            }
            if (l && i) document.getElementById(i).checked ? map.addLayer(l) : map.removeLayer(l);
            if (['SD', 'SMP', 'SMA', 'Terpadu', 'buffer'].includes(t)) updateBufferVisibility();
        }

        function updateBufferVisibility() {
            const isBufferOn = document.getElementById('chkBuffer').checked;

            map.removeLayer(bufferSD);
            map.removeLayer(bufferSMP);
            map.removeLayer(bufferSMA);
            map.removeLayer(bufferTerpadu);

            if (isBufferOn) {
                if (document.getElementById('chkSD').checked) map.addLayer(bufferSD);
                if (document.getElementById('chkSMP').checked) map.addLayer(bufferSMP);
                if (document.getElementById('chkSMA').checked) map.addLayer(bufferSMA);
                if (document.getElementById('chkTerpadu').checked) map.addLayer(bufferTerpadu);
            }
        }

        function toggleBasemapMenu() {
            document.getElementById('basemapDropdown').classList.toggle('show');
        }

        function changeBasemap(v) {
            map.removeLayer(osm);
            map.removeLayer(sat);
            map.removeLayer(topo);
            if (v === 'osm') osm.addTo(map);
            if (v === 'sat') sat.addTo(map);
            if (v === 'topo') topo.addTo(map);
            document.getElementById('basemapDropdown').classList.remove('show');
        }

        function handleSearch(e) {
            if (e.key === 'Enter') doSearch();
        }

        function doSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            if (!query) return alert('Masukkan nama sekolah!');
            const foundFeature = FASKES_SOURCE.find(f => (f.properties.name && f.properties.name.toLowerCase().includes(query)) || (f.properties.NAMA && f.properties.NAMA.toLowerCase().includes(query)));
            if (foundFeature) {
                const coords = foundFeature.geometry.coordinates;
                map.setView([coords[1], coords[0]], 17);
                L.popup().setLatLng([coords[1], coords[0]]).setContent(buildPopup(foundFeature.properties, 'Hasil Pencarian')).openOn(map);
            } else alert('Tidak ditemukan.');
        }

        // PRINT FUNCTION
        function executePrint() {
            const title = document.getElementById('inputPrintTitle').value;
            const layout = document.getElementById('inputPrintLayout').value;
            document.getElementById('printTitleText').innerText = title;
            const now = new Date();
            document.getElementById('printDate').innerText = now.toLocaleDateString('id-ID') + ' ' + now.toLocaleTimeString('id-ID');
            togglePrintModal();
            const style = document.createElement('style');
            style.innerHTML = `@page { size: A4 ${layout}; margin: 0; }`;
            style.id = 'print-page-style';
            document.head.appendChild(style);
            map.invalidateSize();
            setTimeout(() => {
                window.print();
                document.head.removeChild(style);
            }, 500);
        }

        const CustomZoom = L.Control.extend({
            options: {
                position: 'bottomleft'
            },
            onAdd: function(map) {
                const div = L.DomUtil.create('div', 'bottom-tools');
                const btn = (i, f) => {
                    const b = L.DomUtil.create('button', 'zoom-btn', div);
                    b.innerHTML = `<i class="fa-solid ${i}"></i>`;
                    b.onclick = f;
                    return b;
                };
                btn('fa-plus', () => map.zoomIn());
                btn('fa-minus', () => map.zoomOut());
                const home = btn('fa-house', () => map.setView([-6.914744, 107.609810], 11));
                home.style.marginTop = "10px";
                btn('fa-crosshairs', () => map.locate({
                    setView: true,
                    maxZoom: 15
                }));
                return div;
            }
        });
        map.addControl(new CustomZoom());
    </script>
</body>

</html>